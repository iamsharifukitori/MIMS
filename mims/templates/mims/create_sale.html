{% extends 'mims/dashboard.html' %}

{% block content %}
<div class="p-8">
    <div class="mb-8 flex justify-between items-end">
        <div>
            <h2 class="text-2xl font-bold text-slate-800">Process New Sale</h2>
            <p class="text-slate-500 text-sm">Money-first approach: Enter payment in Tsh to calculate units.</p>
        </div>
    </div>

    <form method="POST" id="saleForm">
        {% csrf_token %}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-xl font-bold text-slate-800 mb-6">Items Selection</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full mb-6" id="itemsTable">
                            <thead>
                                <tr class="text-left border-b border-slate-100">
                                    <th class="pb-4 font-bold text-slate-700 w-1/3">Search Medicine</th>
                                    <th class="pb-4 font-bold text-slate-700">Money Paid (Tsh)</th>
                                    <th class="pb-4 font-bold text-slate-700">Qty (Units)</th>
                                    <th class="pb-4 font-bold text-slate-700">Unit Price</th>
                                    <th class="pb-4 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="saleItemsBody" class="divide-y divide-slate-50">
                                <tr class="sale-item-row">
                                    <td class="py-4 pr-4">
                                        <input list="productsList" name="product_name[]" class="product-input w-full p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type medicine name..." required>
                                    </td>
                                    <td class="py-4 pr-4">
                                        <input type="number" name="money_paid[]" class="money-input w-full p-2 border border-slate-200 rounded-lg" placeholder="0" required>
                                    </td>
                                    <td class="py-4 pr-4">
                                        <input type="number" name="quantity[]" class="qty-input w-full p-2 border border-slate-200 rounded-lg bg-slate-50" placeholder="0" required>
                                    </td>
                                    <td class="py-4">
                                        <span class="unit-price font-mono text-slate-500">Tsh 0</span>
                                    </td>
                                    <td class="py-4 text-center">
                                        <button type="button" class="text-red-400 hover:text-red-600 remove-row transition">✕</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <button type="button" id="addRow" class="text-blue-600 font-bold flex items-center gap-2 hover:bg-blue-50 px-4 py-2 rounded-lg transition">
                        <span>➕</span> Add Another Item
                    </button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 h-fit sticky top-24">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Payment & Loan</h3>
                
                <div class="space-y-4">
                    <div>
                        <label id="customerLabel" class="block text-xs font-bold text-slate-500 uppercase mb-1">Customer Name</label>
                        <input type="text" name="customer_name" id="customerInput" placeholder="Optional for cash sales" 
                            class="w-full p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                        <p id="loanWarning" class="text-[10px] text-amber-600 mt-1 hidden">⚠️ Required because balance is > 0</p>
                    </div>

                    <div class="pt-4 border-t border-slate-100">
                        <div class="flex justify-between mb-2">
                            <span class="text-slate-500">Total Bill</span>
                            <span class="font-bold text-blue-600 text-lg" id="displayTotal">Tsh 0</span>
                        </div>
                        
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cash Received (Upfront)</label>
                        <input type="number" name="amount_paid" step="0.01" value="0" id="cashInput"
                            class="w-full p-3 bg-emerald-50 border border-emerald-100 rounded-lg text-emerald-700 font-bold text-xl outline-none">
                        
                        <div class="flex justify-between mt-3 text-sm">
                            <span class="text-slate-500">Remaining Debt:</span>
                            <span class="font-bold text-red-600" id="displayBalance">Tsh 0</span>
                        </div>
                    </div>

                    <div class="flex flex-col gap-3">
                        <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 shadow-lg transition-all">
                            Complete Sale
                        </button>
                        <a href="{% url 'dashboard' %}" class="text-center py-2 text-slate-400 text-sm hover:text-slate-600">Cancel Sale</a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<datalist id="productsList">
    {% for item in products %}
    <option data-id="{{ item.id }}" data-price="{{ item.sell_price_per_base }}" value="{{ item.name }}">
        Stock: {{ item.stock_qty }} | Price: Tsh {{ item.sell_price_per_base }}
    </option>
    {% endfor %}
</datalist>

<script>
    const dataList = document.getElementById('productsList');
    const tbody = document.getElementById('saleItemsBody');
    const cashInput = document.getElementById('cashInput');
    const displayTotal = document.getElementById('displayTotal');
    const displayBalance = document.getElementById('displayBalance');
    const customerInput = document.getElementById('customerInput');
    const loanWarning = document.getElementById('loanWarning');

    function calculateRow(row) {
        const productInput = row.querySelector('.product-input');
        const moneyInput = row.querySelector('.money-input');
        const qtyInput = row.querySelector('.qty-input');
        const priceDisplay = row.querySelector('.unit-price');

        const option = Array.from(dataList.options).find(opt => opt.value === productInput.value);
        
        if (option) {
            const price = parseFloat(option.getAttribute('data-price'));
            priceDisplay.innerText = `Tsh ${price.toLocaleString()}`;
            
            if (document.activeElement === moneyInput) {
                const money = parseFloat(moneyInput.value) || 0;
                // Calculate units based on money
                qtyInput.value = Math.floor(money / price); 
            } 
            else if (document.activeElement === qtyInput) {
                const qty = parseInt(qtyInput.value) || 0;
                // Update money to exactly match price * qty
                moneyInput.value = Math.round(qty * price);
            }
        }
        updateGrandTotal();
    }

    function updateGrandTotal() {
        let total = 0;
        document.querySelectorAll('.money-input').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        
        displayTotal.innerText = `Tsh ${total.toLocaleString()}`;
        
        // PREFILL CASH RECEIVED: Matches total by default
        if (document.activeElement !== cashInput) {
            cashInput.value = total;
        }
        
        updateLoanSummary(total);
    }

    function updateLoanSummary(totalBill) {
        const cash = parseFloat(cashInput.value) || 0;
        const balance = totalBill - cash;
        displayBalance.innerText = "Tsh " + (balance > 0 ? balance.toLocaleString() : "0");

        // DYNAMIC REQUIREMENT: If balance exists, name is required
        if (balance > 0) {
            customerInput.required = true;
            customerInput.classList.add('border-amber-300', 'bg-amber-50');
            loanWarning.classList.remove('hidden');
        } else {
            customerInput.required = false;
            customerInput.classList.remove('border-amber-300', 'bg-amber-50');
            loanWarning.classList.add('hidden');
        }
    }

    tbody.addEventListener('input', (e) => {
        if (e.target.classList.contains('product-input') || 
            e.target.classList.contains('money-input') || 
            e.target.classList.contains('qty-input')) {
            calculateRow(e.target.closest('tr'));
        }
    });

    cashInput.addEventListener('input', () => {
        let total = 0;
        document.querySelectorAll('.money-input').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        updateLoanSummary(total);
    });

    document.getElementById('addRow').addEventListener('click', () => {
        const firstRow = tbody.querySelector('.sale-item-row');
        const newRow = firstRow.cloneNode(true);
        newRow.querySelectorAll('input').forEach(input => input.value = '');
        newRow.querySelector('.unit-price').innerText = 'Tsh 0';
        tbody.appendChild(newRow);
    });

    tbody.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-row')) {
            if (tbody.rows.length > 1) {
                e.target.closest('tr').remove();
                updateGrandTotal();
            }
        }
    });
    
    document.getElementById('saleForm').addEventListener('submit', function(e) {
    // 1. Calculate the current grand total
    let total = 0;
    document.querySelectorAll('.money-input').forEach(input => {
        total += parseFloat(input.value) || 0;
    });

    // 2. Block the sale if total is 0 or less
    if (total <= 0) {
        e.preventDefault(); // Stop the form from sending to the server
        alert("⚠️ Cannot process an empty sale. Please add items with a valid price.");
        return false;
    }

    // 3. (Optional) Double check for Customer Name if it's a loan
    const cash = parseFloat(document.getElementById('cashInput').value) || 0;
    const customer = document.getElementById('customerInput').value.trim();
    
    if (total > cash && !customer) {
        e.preventDefault();
        alert("⚠️ Customer Name is required for loan/partial sales.");
        return false;
    }
});
</script>
{% endblock %}