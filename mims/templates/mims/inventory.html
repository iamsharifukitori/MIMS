{% extends 'mims/dashboard.html' %}

{% block content %}
<style>
    /* Excel-style readability tweaks */
    .excel-table {
        border: 1px solid #e2e8f0;
    }
    .excel-table th {
        background-color: #f8fafc;
        border-bottom: 2px solid #cbd5e1;
        border-right: 1px solid #e2e8f0;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
    }
    .excel-table td {
        border-right: 1px solid #f1f5f9;
        padding: 8px 12px !important; /* Tighter padding for Excel feel */
        font-size: 0.875rem;
    }
    .excel-table tr:nth-child(even) {
        background-color: #fbfcfd; /* Subtle zebra striping */
    }
    .excel-table tr:hover {
        background-color: #f1f5f9 !important;
    }
    @media print {
        aside, .no-print { display: none !important; }
        main { width: 100%; padding: 0; }
        .excel-table { width: 100%; border: 1px solid black; }
    }
</style>

<div class="p-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <h2 class="text-2xl font-bold text-slate-800">Product Inventory</h2>
            <p class="text-sm text-slate-500">Total items tracked: {{ inventory|length }}</p>
        </div>
        
        <div class="flex items-center gap-3 no-print">
            <button onclick="window.print()" class="p-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 text-slate-600 shadow-sm" title="Print Inventory">
                <span>üñ®Ô∏è Print</span>
            </button>
            <a href="/admin/mims/product/add/" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 shadow-md">
                + New Product
            </a>
        </div>
    </div>

    <div class="bg-white p-4 rounded-t-2xl border border-slate-200 border-b-0 flex flex-wrap gap-4 items-center no-print">
        <div class="relative flex-1 min-w-[300px]">
            <span class="absolute left-3 top-2.5 text-slate-400">üîç</span>
            <input type="text" id="inventorySearch" placeholder="Search product name, category..." 
                class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
        </div>
        
        <button class="flex items-center gap-2 px-4 py-2 border border-slate-200 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50">
            <span>‚öôÔ∏è Filter</span>
        </button>
    </div>

    <div class="bg-white rounded-b-2xl shadow-sm overflow-hidden excel-table">
        <table class="w-full text-left border-collapse" id="inventoryTable">
            <thead>
                <tr>
                    <th class="px-6 py-3 text-slate-600 uppercase">Product Name</th>
                    <th class="px-6 py-3 text-slate-600 uppercase">Category</th>
                    <th class="px-6 py-3 text-slate-600 uppercase">Current Stock</th>
                    <th class="px-6 py-3 text-slate-600 uppercase">Retail Price</th>
                    <th class="px-6 py-3 text-slate-600 uppercase">Stock Value</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for entry in inventory %}
                <tr>
                    <td class="font-medium text-slate-800">{{ entry.item.name }}</td>
                    <td class="text-slate-500">{{ entry.item.category.name }}</td>
                    <td>
                        <span class="{% if entry.is_low_stock %}text-red-600 font-bold{% else %}text-slate-800{% endif %}">
                            {{ entry.item.stock_qty }} {{ entry.item.base_unit }}s
                        </span>
                        <span class="text-[10px] text-slate-400 block italic">({{ entry.item.conversion_factor }} per {{ entry.item.bulk_unit }})</span>
                    </td>
                    <td class="font-mono text-slate-700">Tsh {{ entry.item.sell_price_per_base }}</td>
                    <td class="font-mono text-slate-900 font-semibold">Tsh {{ entry.stock_value|floatformat:0 }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="px-6 py-10 text-center text-slate-400 italic">No products found in inventory.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Optimized Search with Debouncing
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    const performSearch = debounce(function() {
        let filter = document.getElementById('inventorySearch').value.toUpperCase();
        let rows = document.querySelector("#inventoryTable tbody").rows;
        
        for (let i = 0; i < rows.length; i++) {
            let productName = rows[i].cells[0].textContent.toUpperCase();
            let category = rows[i].cells[1].textContent.toUpperCase();
            
            if (productName.includes(filter) || category.includes(filter)) {
                rows[i].style.display = "";
            } else {
                rows[i].style.display = "none";
            }      
        }
    }, 200); // 200ms delay to improve performance

    document.getElementById('inventorySearch').addEventListener('keyup', performSearch);
</script>
{% endblock %}